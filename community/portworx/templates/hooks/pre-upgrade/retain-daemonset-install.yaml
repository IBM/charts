{{- $customRegistryURL := .Values.customRegistryURL | default "none" }}
{{- $registrySecret := .Values.registrySecret | default "none" }}

apiVersion: batch/v1
kind: Job
metadata:
  namespace: kube-system
  name: px-hook-retain-daemonset-resources
  labels:
    heritage: {{.Release.Service | quote }}
    release: {{.Release.Name | quote }}
    chart: "{{.Chart.Name}}-{{.Chart.Version}}"
    app.kubernetes.io/managed-by: {{.Release.Service | quote }}
    app.kubernetes.io/instance: {{.Release.Name | quote }}
  annotations:
    "helm.sh/hook": pre-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  {{ if semverCompare ">= 1.8" .Capabilities.KubeVersion.GitVersion }}
  backoffLimit: 0
  {{ else }}
  activeDeadlineSeconds: 30
  {{ end }}
  template:
    spec:
      {{- if not (eq $registrySecret "none") }}
      imagePullSecrets:
        - name: {{ $registrySecret }}
      {{- end }}
      serviceAccountName: {{ template "px.hookServiceAccount" . }}
      restartPolicy: Never
      containers:
        - name: retain-px-daemonset
          image: {{ template "px.getK8KubectlImage" . }}:{{ template "px.kubernetesVersion" . }}
          command: ['/bin/sh',
                    '-c',
                    'kubectl -n kube-system annotate DaemonSet portworx-api helm.sh/resource-policy=keep --overwrite
                     kubectl -n kube-system annotate DaemonSet portworx helm.sh/resource-policy=keep --overwrite

                     kubectl -n kube-system annotate Service stork-service helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Service prometheus helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Service portworx-service helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Service autopilot helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Service grafana helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Service alertmanager-portworx helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Service px-csi-service helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Service portworx-api helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Deployment stork-scheduler helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Deployment px-csi-ext helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Deployment autopilot helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Deployment grafana helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Deployment stork helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Deployment prometheus-operator helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Deployment portworx-pvc-controller helm.sh/resource-policy=keep --overwrite || true;

                     kubectl -n kube-system annotate RoleBinding px-role-binding helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Role px-role helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRoleBinding stork-scheduler-role-binding helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRoleBinding stork-role-binding helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRoleBinding node-role-binding helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRoleBinding prometheus helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRoleBinding px-csi-role-binding helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRoleBinding autopilot-role-binding helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRoleBinding prometheus-operator helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRoleBinding portworx-pvc-controller-role-binding helm.sh/resource-policy=keep --overwrite || true;

                     kubectl -n kube-system annotate ClusterRole stork-scheduler-role helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRole autopilot-role helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRole prometheus helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRole prometheus-operator helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRole node-get-put-list-role helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRole px-csi-role helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRole stork-role helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ClusterRole portworx-pvc-controller-role helm.sh/resource-policy=keep --overwrite || true;

                     kubectl -n kube-system annotate StorageClass stork-snapshot-sc helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate StorageClass portworx-shared-sc helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate StorageClass portworx-db2-sc helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate StorageClass portworx-null-sc helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate StorageClass portworx-db-sc helm.sh/resource-policy=keep --overwrite || true;

                     kubectl -n kube-system annotate ConfigMap grafana-dashboard-config helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ConfigMap autopilot-config helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ConfigMap grafana-dashboards helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ConfigMap grafana-source-config helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ConfigMap stork-config helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ConfigMap px-telemetry-config helm.sh/resource-policy=keep --overwrite || true;

                     kubectl -n kube-system annotate ServiceAccount stork-scheduler-account helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ServiceAccount px-account helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ServiceAccount prometheus-operator helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ServiceAccount px-csi-account helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ServiceAccount stork-account helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ServiceAccount prometheus helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ServiceAccount autopilot-account helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ServiceAccount portworx-pvc-controller-account helm.sh/resource-policy=keep --overwrite || true;

                     kubectl -n kube-system annotate Alertmanager portworx helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate CSIDriver pxd.portworx.com helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate Prometheus prometheus helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate PrometheusRule prometheus-portworx-rules-portworx.rules.yaml helm.sh/resource-policy=keep --overwrite || true;
                     kubectl -n kube-system annotate ServiceMonitor portworx-prometheus-sm helm.sh/resource-policy=keep --overwrite || true;
                     ']

