apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "common-scripts.fullname" . }}-pre-upgrade-config
  labels:
{{- include "common.label.metadata" (list . (printf "%s-%s" (include "common-scripts.name" .) "config") (include "common-scripts.chart" .) .Release.Name .Release.Service ) | indent 4 }}
  annotations:
    "helm.sh/hook": pre-upgrade,pre-install
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  template:
    metadata:
      labels:
{{- include "common.label.metadata" (list . (printf "%s-%s" (include "common-scripts.name" .) "config") (include "common-scripts.chart" .) .Release.Name .Release.Service ) | indent 8 }}
      annotations:
{{ include "common.meteringAnnotations" . | indent 8}}
    spec:
{{ include "common.configureHostAliases" . | indent 6 }}
{{ include "common.PodHostConfig" . | indent 6 }}
      securityContext:
{{ include "common.PodSecurityContextConfig" . | indent 8 }}
      affinity:
{{ include "common.ArchNodeAffinity" . | indent 8 }}
      restartPolicy: Never
      serviceAccountName: fci-common-scripts
      volumes:
      - name: internal-tls
        secret:
          defaultMode: 420
          secretName: internal-tls
      containers:
        - name: {{ template "common-scripts.fullname" . }}
          securityContext:
{{ include "common.RestrictedContainerSecurityContext" . | indent 12 }}
          image: "{{ required "global.dockerRegistryPrefix must specify from which repository the docker image should be fetched." .Values.global.dockerRegistryPrefix }}/{{ .Values.global.commonScripts.image.repository }}:{{ .Values.global.commonScripts.image.tag }}"
          imagePullPolicy: {{ .Values.global.commonScripts.image.pullPolicy }}
          env:
          - name: RELEASE_NAME
            value: {{ .Release.Name }}
          - name: CONFIG_CONFIGMAP
            value: {{ .Release.Name }}-platform-config-files
          - name: SWIDTAGS_CONFIGMAP
            value: {{ .Release.Name }}-swidtag-files
          - name: FCI_PRODUCT_NAME
            value: {{ .Values.global.productName }}
          - name: UPDATE_PRODUCT_NAME
            value: "{{ .Values.global.updateProductName }}"
{{- include "common.import-secret" (list . "TRUSTSTORE_PWD" "platform" "FCI_JKS_PASSWORD") | indent 10 }}
          command:
            - bash
            - -c
            - /common-scripts/fci-preinstall-config.sh
          volumeMounts:
          - mountPath: /etc/internal-tls
            name: internal-tls
          resources:
{{ toYaml .Values.resources | indent 12 }}
