# begin_generated_IBM_copyright_prolog                             
#                                                                  
# This is an automatically generated copyright prolog.             
# After initializing,  DO NOT MODIFY OR MOVE                       
# **************************************************************** 
# Licensed Materials - Property of IBM                             
# 5724-Y95                                                         
# (C) Copyright IBM Corp.  2019, 2019    All Rights Reserved.      
# US Government Users Restricted Rights - Use, duplication or      
# disclosure restricted by GSA ADP Schedule Contract with          
# IBM Corp.                                                        
#                                                                  
# end_generated_IBM_copyright_prolog                               
apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{.Release.Name}}-upgrade-instance-config"
  labels:
{{- include "streams.defaultLabels" . | indent 4 }}
{{- include "streams.serviceability" . | indent 4 }}
    app.kubernetes.io/name: "{{.Release.Name}}-upgrade-instance-config"
  annotations:
    "helm.sh/hook": post-upgrade,post-rollback
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded,hook-failed
data:
  instance.properties: |
    {{- if .Values.app }}
    app.metricCollectionInterval={{.Values.app.metricCollectionInterval | default "3"}}
    app.pecStartTimeout={{.Values.app.pecStartTimeout | default "30"}}
    app.pecStopTimeout={{.Values.app.pecStopTimeout | default "30"}}
    {{- end }}

    {{- if .Values.auditlog }}
    auditlog.level={{.Values.auditlog.level | default "off"}}
    {{- end }}

    {{- if .Values.controller }}
    controller.startTimeout={{.Values.controller.startTimeout | default "60"}}
    controller.stopTimeout={{.Values.controller.stopTimeout | default "60"}}
    controller.systemStatisticsInterval={{.Values.controller.systemStatisticsInterval | default "60"}}
    {{- end }}

    {{- if .Values.instance }}
    instance.applicationEnvironmentVariables={{.Values.instance.applicationEnvironmentVariables | default "<undefined>"}}
    instance.applicationQuotaAttributes={{.Values.instance.applicationQuotaAttributes | default "<undefined>"}}
    instance.governanceEnabled={{.Values.instance.governanceEnabled | default "false"}}
    instance.governanceUrl={{.Values.instance.governanceUrl | default "<undefined>"}}
    instance.jobsCpuMaximum={{.Values.instance.jobsCpuMaximum | default "<undefined>"}}
    instance.localeOverride={{.Values.instance.localeOverride | default "<undefined>"}}
    instance.metricStatisticsRetentionScheme={{.Values.instance.metricStatisticsRetentionScheme | default "slidingTimeWindow"}}
    instance.metricStatisticsRetentionSize={{.Values.instance.metricStatisticsRetentionSize | default "10"}}
    instance.owner={{.Values.instance.owner | default "<undefined>"}}
    instance.repositoryConfigurationApplicationCache={{.Values.instance.repositoryConfigurationApplicationCache | default "{\"type\":\"filesystem\",\"baseDirectory\":\"/opt/ibm/streams-state\"}"}}
    instance.serviceMetricCollectionEnabled={{.Values.instance.serviceMetricCollectionEnabled | default "false"}}
    instance.sslOption={{.Values.instance.sslOption | default "TLSv1.2"}}
    {{- end }}

    {{- if .Values.jmx }}
    jmx.inactivityTimeout={{.Values.jmx.inactivityTimeout | default "30"}}
    {{- end }}

    {{- if .Values.job }}
    job.checkpointRepository={{.Values.job.checkpointRepository | default "notSpecified"}}
    job.checkpointRepositoryConfiguration={{.Values.job.checkpointRepositoryConfiguration | default "<undefined>"}}
    job.cpuMaximum={{.Values.job.cpuMaximum | default "20"}}
    {{- if and (empty .Values.job.dynamicThreadingElastic) (not (eq (toString .Values.job.dynamicThreadingElastic) "false")) }}
    job.dynamicThreadingElastic=<undefined>
    {{- else }}
    job.dynamicThreadingElastic={{.Values.job.dynamicThreadingElastic }}
    {{- end }}
    job.dynamicThreadingThreadCount={{.Values.job.dynamicThreadingThreadCount | default "<undefined>"}}
    {{- if or (and (empty .Values.job.restartPesOnResourceFailure) (not (eq (toString .Values.job.restartPesOnResourceFailure) "false"))) (eq (toString .Values.job.restartPesOnResourceFailure) "true") }}
    job.restartPesOnResourceFailure=true
    {{- else }}
    job.restartPesOnResourceFailure=false
    {{- end }}
    job.restartPesOnResourceFailureWaitTime={{.Values.job.restartPesOnResourceFailureWaitTime | default "300"}}
    job.threadingModel={{.Values.job.threadingModel | default "notSpecified"}}
    job.transportSecurityType={{.Values.job.transportSecurityType | default "none"}}
    {{- end }}

    {{- if .Values.log }}
    log.level={{.Values.log.level | default "warn"}}
    log.maximumFileCount={{.Values.log.maximumFileCount | default "3"}}
    log.maximumFileSize={{.Values.log.maximumFileSize | default "5000"}}
    {{- end }}

    {{- if .Values.security }}
    security.administratorGroup={{.Values.security.administratorGroup | default "<undefined>"}}
    security.administratorUser={{.Values.security.administratorUser | default "<undefined>"}}
    security.certificateUserRegularExpression={{.Values.security.certificateUserRegularExpression | default "${cn}"}}
    {{- if or (and (empty .Values.security.ldapEnabled) (not (eq (toString .Values.security.ldapEnabled) "false"))) (eq (toString .Values.security.ldapEnabled) "true") }}
    security.ldapEnabled=true
    {{- else }}
    security.ldapEnabled=false
    {{- end }}
    security.ldapGroupMembersAttribute={{.Values.security.ldapGroupMembersAttribute | default "<undefined>"}}
    security.ldapGroupObjectClass={{.Values.security.ldapGroupObjectClass | default "<undefined>"}}
    security.ldapGroupSearchBaseDistinguishedName={{.Values.security.ldapGroupSearchBaseDistinguishedName | default "<undefined>"}}
    security.ldapServerUrl={{.Values.security.ldapServerUrl | default "<undefined>"}}
    security.ldapUserAttributeInGroup={{.Values.security.ldapUserAttributeInGroup | default "<undefined>"}}
    security.ldapUserDistinguishedNamePattern={{.Values.security.ldapUserDistinguishedNamePattern | default "<undefined>"}}
    security.ldapUserSecondaryLookup={{.Values.security.ldapUserSecondaryLookup | default "<undefined>"}}
    security.revocationLdapUrl={{.Values.security.revocationLdapUrl | default "<undefined>"}}
    security.revocationMethod={{.Values.security.revocationMethod | default "automatic"}}
    security.sessionTimeout={{.Values.security.sessionTimeout | default "14400"}}
    security.ssoEnabled={{.Values.security.ssoEnabled | default "false"}}
    security.ssoRealm={{.Values.security.ssoRealm | default "<undefined>"}}
    security.ssoUrl={{.Values.security.ssoUrl | default "<undefined>"}}
    security.userGroup={{.Values.security.userGroup | default "<undefined>"}}
    {{- end }}

    {{- if .Values.sws }}
    {{- if or (and (empty .Values.sws.clientAuthenticationCertificateRequired) (not (eq (toString .Values.sws.clientAuthenticationCertificateRequired) "false"))) (eq (toString .Values.sws.clientAuthenticationCertificateRequired) "true") }}
    sws.clientAuthenticationCertificateRequired=true
    {{- else }}
    sws.clientAuthenticationCertificateRequired=false
    {{- end }}
    sws.clientAuthenticationEnabled={{.Values.sws.clientAuthenticationEnabled | default "false"}}
    sws.cryptographicKeyManagementMode={{.Values.sws.cryptographicKeyManagementMode | default "strict"}}
    {{- end }}

    {{- if .Values.trace }}
    trace.level={{.Values.trace.level | default "error"}}
    trace.maximumFileCount={{.Values.trace.maximumFileCount | default "3"}}
    trace.maximumFileSize={{.Values.trace.maximumFileSize | default "5000"}}
    {{- end }}
