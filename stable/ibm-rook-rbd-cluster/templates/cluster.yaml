###############################################################################
# Licensed Materials - Property of IBM
# 5737-E67
# (C) Copyright IBM Corporation 2016, 2018 All Rights Reserved
# US Government Users Restricted Rights - Use, duplication or disclosure
# restricted by GSA ADP Schedule Contract with IBM Corp.
###############################################################################

{{- include "sch.config.init" (list . "ibm-rook-rbd-cluster.sch.chart.config.values") }}
{{- $clusterName :=  .sch.chart.components.cluster.name }}
{{- $cephosdSaName :=  .sch.chart.components.cephosdsa.name }}

apiVersion: ceph.rook.io/v1beta1
kind: Cluster
metadata:
  name: {{ include "sch.names.fullCompName" (list . $clusterName) }}
  namespace: {{ .Release.Namespace }}
  labels:
{{ include "sch.metadata.labels.standard" (list . $clusterName) | indent 4 }}
spec:
  # The path on the host where configuration files will be persisted. If not
  # specified, a kubernetes emptyDir will be created (not recommended).
  # Important: if you reinstall the cluster, make sure you delete this directory
  # from each host or else the mons will fail to start on the new cluster.
  dataDirHostPath: {{ .Values.cluster.dataDirHostPath }}
  # The service account under which to run the daemon pods in this cluster if the default
  # account is not sufficient (OSDs)
  serviceAccount: {{ $cephosdSaName }}
  # set the amount of mons to be started
  mon:
    count: {{ .Values.cluster.mon.count }}
    allowMultiplePerNode: {{ .Values.cluster.mon.allowMultiplePerNode }}
  # enable the ceph dashboard for viewing cluster status
  dashboard:
    enabled: {{ .Values.cluster.dashboard.enabled }}
  network:
  # toggle to use hostNetwork
    hostNetwork: {{ .Values.cluster.network.hostNetwork }}
 
  # Placement configuration for the cluster services. It includes the following keys: mgr, mon,
  # osd and all. Each service will have its placement configuration generated by merging the generic
  # configuration under all with the most specific one (which will override any attributes). 
  placement:
  {{- if .Values.cluster.placement.all.enabled }}
    all:
  {{- if .Values.cluster.placement.all.nodeSelectorTerms }}
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
{{ toYaml .Values.cluster.placement.all.nodeSelectorTerms | indent 10 }}
  {{- end }}
  {{- if .Values.cluster.placement.all.tolerations }}
      tolerations:
{{ toYaml .Values.cluster.placement.all.tolerations | indent 8 }}
  {{- end }}
  {{- end }}

  {{- if .Values.cluster.placement.mon.enabled }}
    mon:
  {{- if .Values.cluster.placement.mon.nodeSelectorTerms }}
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
{{ toYaml .Values.cluster.placement.mon.nodeSelectorTerms | indent 10 }}
  {{- end }}
  {{- if .Values.cluster.placement.mon.tolerations }}
      tolerations:
{{ toYaml .Values.cluster.placement.mon.tolerations | indent 8 }}
  {{- end }}
  {{- end }}

  {{- if .Values.cluster.placement.mgr.enabled }}
    mgr:
  {{- if .Values.cluster.placement.mgr.nodeSelectorTerms }}
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
{{ toYaml .Values.cluster.placement.mgr.nodeSelectorTerms | indent 10 }}
  {{- end }}
  {{- if .Values.cluster.placement.mgr.tolerations }}
      tolerations:
{{ toYaml .Values.cluster.placement.mgr.tolerations | indent 8 }}
  {{- end }}
  {{- end }}

  {{- if .Values.cluster.placement.osd.enabled }}
    osd:
  {{- if .Values.cluster.placement.osd.nodeSelectorTerms }}
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
{{ toYaml .Values.cluster.placement.osd.nodeSelectorTerms | indent 10 }}
  {{- end }}
  {{- if .Values.cluster.placement.osd.tolerations }}
      tolerations:
{{ toYaml .Values.cluster.placement.osd.tolerations | indent 8 }}
  {{- end }}
  {{- end }}

  {{- if .Values.cluster.resources }}
  resources:
{{ toYaml .Values.cluster.resources | indent 4 }}
  {{- end }}
  storage:
    useAllNodes: {{ .Values.cluster.storage.useAllNodes }}
    useAllDevices: {{ .Values.cluster.storage.useAllDevices }}
{{- if .Values.cluster.storage.deviceFilter }}
    deviceFilter: {{ .Values.cluster.storage.deviceFilter }}
{{- end }}
    location: {{ .Values.cluster.storage.location }}
    config:
      # The default and recommended storeType is dynamically set to bluestore for devices
      # and filestore for directories.
      storeType: {{ .Values.cluster.storage.config.storeType }}
      # This value can be removed for environments with normal sized disks (100 GB or larger)
      databaseSizeMB: {{ .Values.cluster.storage.config.databaseSizeMB | quote }}
      # This value can be removed for environments with normal sized disks (20 GB or larger)
      journalSizeMB: {{ .Values.cluster.storage.config.journalSizeMB | quote }}
    nodes:
{{ toYaml .Values.cluster.storage.nodes | indent 6 }}
