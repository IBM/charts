apiVersion: v1
kind: Pod
metadata:
  name: mongodb-test
  labels:
    name: mongodb-test
{{ include "core.test-labels" .  | indent 4 }}
  annotations:
    "helm.sh/hook": test-success
spec:
  affinity:
{{ include "core.nodeaffinity" . | indent 4 }}
{{ include "core.securityContext" .  | indent 2 }}
{{ include "core.imagePullSecrets" .  | indent 2 }}
  containers:
    - name: mongodb-test
      {{- template "isIcp" . -}}
      {{- if not (.Values.isIcp) }}
      image: {{ template "core.readConfig" (list . "cb_mongodb") }}
      {{ else }}
      image: {{ template "coreicp.readConfig" (list . "cb_mongodb" .Values.imageCredentials.registry) }}
      {{ end }}
{{ include "core.container.securityContext" . | indent 6  }}
      env:
       - name: MONGO_INITDB_ROOT_USERNAME
         valueFrom:
              secretKeyRef:
                name: mongodb-creds
                key: mongodb.username
       - name: MONGO_INITDB_ROOT_PASSWORD
         valueFrom:
              secretKeyRef:
                name: mongodb-creds
                key: mongodb.password

      command: ["sh", "-c", "mongo mongodb://mongodb:27017 -u $MONGO_INITDB_ROOT_USERNAME -p $MONGO_INITDB_ROOT_PASSWORD --authenticationDatabase admin --eval 'db.runCommand({ping: 1})'"]
  restartPolicy: Never
