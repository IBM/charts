apiVersion: batch/v1
kind: Job
metadata:
  name: cb-mongodb-migrator
  labels:
{{ include "core.labels" .  | indent 4 }}
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: hook-failed,hook-succeeded
    helm.sh/hook-weight: "1"
spec:
  template:
    metadata:
      labels:
        name: cb-mongodb-migrator # referenced by dash.gravitant.net for Pod Name
{{ include "core.labels" .  | indent 8 }}
      annotations:
{{ include "core.icpMetering" .  | indent 8 }}
    spec:
{{ include "core.imagePullSecrets" .  | indent 6 }}
      affinity:
{{- include "core.nodeaffinity" . | indent 6 }}
{{ include "core.securityContext" .  | indent 6 }}
      containers:
        {{- template "isIcp" . -}}
        {{- if not (.Values.isIcp) }}
        - image: {{ template "core.readConfig" (list . "cb_couchdb_br") }}
        {{ else }}
        - image: {{ template "coreicp.readConfig" (list . "cb_couchdb_br" .Values.imageCredentials.registry) }}
        {{ end }}
          securityContext:
            privileged: false
            readOnlyRootFilesystem: false
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 65534
            capabilities:
              drop:
              - ALL
          name: cb-mongodb-migrator
          command: ["./couch_to_mongo_migrator.sh"]
          env:
            # CouchDB
            - name: COUCHDB_USER
              valueFrom:
                secretKeyRef:
                  name: couchdb-creds
                  key: couchdb.username
            - name: COUCHDB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: couchdb-creds
                  key: couchdb.password
            - name: COUCHDB_HOSTNAME
              value: "couchdb"
            - name: COUCHDB_PORT
              value: "5984"
            # comma separated entries <couchdb database name>|<mongodb database name>
            # Example: "config_service|configuration,teams_v2|authorization,auditlogdb|audit"
            - name: COUCHDB_DATABASES
              value: "config_service|configuration,auditlogdb|audit_service,auditarchivedb|audit_service,creds-db|creds-db"

            # MongoDB
            - name: MONGODB_HOSTNAME
              value: "mongodb"
            - name: MONGODB_PORT
              value: "27017"
            - name: MONGO_DB_PROTOCOL
              value: mongodb
            - name: MONGODB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mongodb-creds
                  key:  mongodb.username
            - name: MONGODB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-creds
                  key: mongodb.password
          {{ if .Values.httpProxy }}
            # HTTP_PROXY support
            - name: http_proxy
              value: {{ .Values.httpProxy }}
            - name: https_proxy
              value: {{ .Values.httpsProxy }}
            - name: no_proxy
              value: "{{ .Release.Namespace }},{{ .Values.noProxy }}"
          {{ end }}
          resources:
{{ include "deployClassConfig" (list . "cb_mongodb_migrator") | indent 12 }}
      restartPolicy: Never
