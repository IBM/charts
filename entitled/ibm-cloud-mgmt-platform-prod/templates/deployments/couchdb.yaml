
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: couchdb
  labels:
{{ include "core.labels" .  | indent 4 }}
spec:
  replicas: 1
  revisionHistoryLimit: 1
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        io.kompose.service: couchdb
        name: couchdb # referenced by dash.gravitant.net for Pod Name
{{ include "core.labels" .  | indent 8 }}
      annotations:
{{ include "core.icpMetering" .  | indent 8 }}
    spec:
{{ include "core.imagePullSecrets" .  | indent 6 }}
{{ include "core.securityContext" .  | indent 6 }}
      affinity:
      {{- include "core.nodeaffinity" . | indent 6 }}
      containers:
        - env:
            - name: COUCHDB_USER
              valueFrom:
                secretKeyRef:
                  name: couchdb-creds
                  key: couchdb.username
            - name: COUCHDB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: couchdb-creds
                  key: couchdb.password
          {{ if .Values.httpProxy }}
            # HTTP_PROXY support
            - name: http_proxy
              value: {{ .Values.httpProxy }}
            - name: https_proxy
              value: {{ .Values.httpsProxy}}
            - name: no_proxy
              value: "{{ .Release.Namespace }},{{ .Values.noProxy }}"
          {{ end }}
          {{- template "isIcp" . -}}
          {{- if not (.Values.isIcp) }}
          image: {{ template "core.readConfig" (list . "cb_couchdb") }}
          {{ else }}
          image: {{ template "coreicp.readConfig" (list . "cb_couchdb" .Values.imageCredentials.registry) }}
          {{ end }}
          securityContext:
            privileged: false
            readOnlyRootFilesystem: false
            allowPrivilegeEscalation: false
            runAsNonRoot: false
            runAsUser: 0
            capabilities:
              add:
              - SETGID
              - CHOWN
              - FOWNER
              - SETUID
              - DAC_OVERRIDE
              drop:
              - ALL
          name: couchdb
          ports:
            - containerPort: 5984
          resources:
{{ include "deployClassConfig" (list . "cb_couchdb") | indent 12 }}
          volumeMounts:
            - mountPath: /opt/couchdb/data
              name: core-couchdb-claim0
              subPath: opt/couchdb/data
          readinessProbe:
            httpGet:
              path: /
              port: 5984
          livenessProbe:
            httpGet:
              path: /
              port: 5984
            initialDelaySeconds: 60
            periodSeconds: 120
            failureThreshold: 4
      restartPolicy: Always
      volumes:
        - name: core-couchdb-claim0
          persistentVolumeClaim:
            claimName: core-couchdb-claim0
