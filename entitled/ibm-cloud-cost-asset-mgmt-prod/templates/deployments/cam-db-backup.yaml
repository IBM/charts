# DO NOT modify this conditional check
{{ if eq (.Values.enableBackups|quote|lower) "\"true\"" }}
{{ if eq (.Values.enableXtraBackup|quote|lower) "\"false\"" }}

apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: mariadb-dbbackup
  labels:
{{ include "cam.labels" .  | indent 4 }}
spec:
  replicas: 1
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      name: mariadb-dbbackup
  template:
    metadata:
      labels:
        name: mariadb-dbbackup
{{ include "cam.labels" .  | indent 8 }}
      annotations:
{{ include "cam.icpMetering" .  | indent 8 }}
        # this check will be removed when  IBMPrivateCloud/roadmap/issues/9525
        # and IBMPrivateCloud/roadmap/issues/10640 is fixed by ICP
        {{- template "isIcp" . -}}
        {{- if not (.Values.isIcp) }}
        # checksums -- to force pod restarts if secrets/configmaps change (first 12-chars of sorted b64 encoded)
        checksums/mysql-username: "{{ .Values.secrets.mysqlUsername | b64enc | sha256sum }}"
        checksums/mysql-password: "{{ .Values.secrets.mysqlKey | b64enc | sha256sum }}"
        checksums/s3.url: "{{ .Values.secrets.s3Url | b64enc | sha256sum }}"
        checksums/s3.access_key_id: "{{ .Values.secrets.s3AccessKeyId | b64enc | sha256sum }}"
        checksums/s3.secret_access_key: "{{ .Values.secrets.s3SecretAccessKey | b64enc | sha256sum }}"
        checksums/encryption_passphrase: "{{ .Values.secrets.backupPassphrase | b64enc | sha256sum }}"
        {{ end }}
    spec:
{{ include "ibm-cloud-brokerage-cam.imagePullSecrets" .  | indent 6 }}
      affinity:
      {{- include "cam.nodeaffinity" . | indent 6 }}
{{ include "cam.securityContext" .  | indent 6 }}
      containers:
      {{- template "isIcp" . -}}
      {{- if not (.Values.isIcp) }}
      - image: {{ template "cam.readConfig" (list . "cam_db_backup") }}
      {{ else }}
      - image: {{ template "camicp.readConfig" (list . "cam_db_backup" .Values.imageCredentials.registry) }}
      {{ end }}
{{ include "cam.container.securityContext" . | indent 8  }}
        name: cam-db-backup
        resources:
{{ include "deployClassConfig" (list . "cam_db_backup") | indent 10 }}
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-password
              key: mysql.key
        - name:  S3_ENDPOINT_HTTPURL
          valueFrom:
            secretKeyRef:
              name: s3
              key: s3.url
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: s3
              key: s3.access_key_id
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: s3
              key: s3.secret_access_key
        - name: BACKUP_PASSPHRASE
          valueFrom:
            secretKeyRef:
              name: s3
              key: encryption_passphrase
        - name: k8Cluster
          value: "{{ .Values.k8Cluster }}"
        - name: ENABLE_BACKUPS
          value: "{{ .Values.enableBackups }}"
        readinessProbe:
            tcpSocket:
              port: 5005
            initialDelaySeconds: 10
            periodSeconds: 10
        livenessProbe:
            tcpSocket:
              port: 5005
            initialDelaySeconds: 120
            periodSeconds: 120
        volumeMounts:
        - name: mariadb-backup
          mountPath: /data
      volumes:
      - name: mariadb-backup
        persistentVolumeClaim:
          claimName: mariadb-backup-claim
      # DO NOT modify this conditional check
      {{ if eq (.Values.externalDB.enableExternalDB|quote|lower) "\"true\"" }}
      nodeSelector:
        role: {{ .Values.nodeRole }}
        datacenter: {{ .Values.externalDB.dataCenter }}
      {{ end }}
{{ end }}
{{ end }}
