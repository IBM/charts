apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: rabbitmq
  labels:
{{ include "cam.labels" .  | indent 4 }}
spec:
  replicas: 1
  revisionHistoryLimit: 1
  template:
    metadata:
      labels:
        io.kompose.service: rabbitmq
        name: rabbitmq # referenced by dash.gravitant.net for Pod Name
{{ include "cam.labels" .  | indent 8 }}
      annotations:
{{ include "cam.icpMetering" .  | indent 8 }}
        # this check will be removed when  IBMPrivateCloud/roadmap/issues/9525
        # and IBMPrivateCloud/roadmap/issues/10640 is fixed by ICP
        {{- template "isIcp" . -}}
        {{- if not (.Values.isIcp) }}
        # checksums -- to force pod restarts if secrets/configmaps change
        checksums/rabbitmq.username: "{{ .Values.secrets.rabbitmqDefaultUser | b64enc | sha256sum }}"
        checksums/rabbitmq.password: "{{ .Values.secrets.rabbitmqDefaultPassword | b64enc | sha256sum }}"
        {{ end }}
    spec:
      hostname: rabbitmq # must set static hostname (will lose state on restarts if not)
{{ include "ibm-cloud-brokerage-cam.imagePullSecrets" .  | indent 6 }}
      affinity:
      {{- include "cam.nodeaffinity" . | indent 6 }}
{{ include "cam.securityContext" .  | indent 6 }}
      initContainers:
        - name: user-change
          {{- if not (.Values.isIcp) }}
          image: {{ template "cam.readConfig" (list . "cb_rabbitmq") }}
          {{ else }}
          image: {{ template "camicp.readConfig" (list . "cb_rabbitmq" .Values.imageCredentials.registry) }}
          {{ end }}
{{ include "cam.container.securityContext.InitContainer" . | indent 10  }}
          command: ['sh', '-c', 'chown -R 100:101 /var/lib/rabbitmq/mnesia /var/log/rabbitmq']
          volumeMounts:
           - mountPath: /var/lib/rabbitmq/mnesia
             name: cam-rabbitmq-claim0
             subPath: var/lib/rabbitmq/mnesia
           - mountPath: /var/log/rabbitmq
             name: cam-rabbitmq-claim0
             subPath: var/log/rabbitmq
      containers:
        - env:
            - name: RABBITMQ_DEFAULT_USER
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-creds
                  key: rabbitmq.username
            - name: RABBITMQ_DEFAULT_PASS
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-creds
                  key: rabbitmq.password
            - name: RABBITMQ_ERLANG_COOKIE
              value: secret_cookie
          {{- template "isIcp" . -}}
          {{- if not (.Values.isIcp) }}
          image: {{ template "cam.readConfig" (list . "cb_rabbitmq") }}
          {{ else }}
          image: {{ template "camicp.readConfig" (list . "cb_rabbitmq" .Values.imageCredentials.registry) }}
          {{ end }}
          securityContext:
            privileged: false
            readOnlyRootFilesystem: false
            allowPrivilegeEscalation: false
            runAsNonRoot: false
            runAsUser: 100
            capabilities:
              add: ["SETGID"]
              drop:
              - ALL
          name: rabbitmq
          ports:
            - containerPort: 5672
            - containerPort: 15672
            - containerPort: 25672
          readinessProbe:
            exec:
              command:
              - rabbitmqctl
              - status
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 10
          livenessProbe:
            exec:
              command:
              - rabbitmqctl
              - node_health_check
            initialDelaySeconds: 120
            timeoutSeconds: 10
            periodSeconds: 60
            failureThreshold: 4
          resources:
{{ include "deployClassConfig" (list . "cb_rabbitmq") | indent 12 }}
          volumeMounts:
            - mountPath: /var/lib/rabbitmq/mnesia
              name: cam-rabbitmq-claim0
              subPath: var/lib/rabbitmq/mnesia
            - mountPath: /var/log/rabbitmq
              name: cam-rabbitmq-claim0
              subPath: var/log/rabbitmq
      restartPolicy: Always
      volumes:
        - name: cam-rabbitmq-claim0
          persistentVolumeClaim:
            claimName: cam-rabbitmq-claim0
      # DO NOT modify this conditional check
      {{ if eq (.Values.externalDB.enableExternalDB|quote|lower) "\"true\"" }}
      nodeSelector:
        role: {{ .Values.nodeRole }}
        datacenter: {{ .Values.externalDB.dataCenter }}
      {{ end }}
