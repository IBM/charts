apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: cam-orch-v2
  labels:
{{ include "cam.labels" .  | indent 4 }}
spec:
  replicas: 1
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      name: cam-orch-v2
  template:
    metadata:
      labels:
        name: cam-orch-v2
{{ include "cam.labels" .  | indent 8 }}
      annotations:
{{ include "cam.icpMetering" .  | indent 8 }}
        # this check will be removed when  IBMPrivateCloud/roadmap/issues/9525
        # and IBMPrivateCloud/roadmap/issues/10640 is fixed by ICP
        {{- template "isIcp" . -}}
        {{- if not (.Values.isIcp) }}
        # checksums -- to force pod restarts if secrets/configmaps change
        checksums/mysql-username: "{{ .Values.secrets.mysqlUsername | b64enc | sha256sum }}"
        checksums/mysql-password: "{{ .Values.secrets.mysqlKey | b64enc | sha256sum }}"
        checksums/rabbitmq.username: "{{ .Values.secrets.rabbitmqDefaultUser | b64enc | sha256sum }}"
        checksums/rabbitmq.password: "{{ .Values.secrets.rabbitmqDefaultPassword | b64enc | sha256sum }}"
        checksums/slack-hooks-qa: "{{ .Values.secrets.slackHookQA | b64enc | sha256sum }}"
        checksums/slack-hooks-prod: "{{ .Values.secrets.slackHookProd | b64enc | sha256sum }}"
        {{ end }}
    spec:
{{ include "ibm-cloud-brokerage-cam.imagePullSecrets" .  | indent 6 }}
      affinity:
      {{- include "cam.nodeaffinity" . | indent 6 }}
{{ include "cam.securityContext" .  | indent 6 }}
      initContainers:
        - name: user-change
          {{- if not (.Values.isIcp) }}
          image: {{ template "cam.readConfig" (list . "k8_jumpbox") }}
          {{ else }}
          image: {{ template "camicp.readConfig" (list . "k8_jumpbox" .Values.imageCredentials.registry) }}
          {{ end }}
{{ include "cam.container.securityContext.InitContainer" . | indent 10  }}
          command: ['sh', '-c', 'chown -R 1100:1101 /var/gpd/ && chown -R 1100:1101 /var/camrecommend/  && chown -R 1100:1101 /zip/']
          volumeMounts:
            - name: cam-data
              mountPath: /var/gpd/analyze_temp
              subPath: gpd/analyze_temp
            - name: cam-data
              mountPath: /var/gpd/temp_uploads
              subPath: gpd/temp_uploads
            - name: cam-data
              mountPath: /var/gpd/staged_uploads
              subPath: gpd/staged_uploads
            - name: cam-data
              mountPath: /var/gpd/zip
              subPath: gpd/zip
            - name: cam-data
              mountPath: /var/gpd/extracts
              subPath: gpd/extracts
            - name: cam-data
              mountPath: /zip
            - name: cam-data
              mountPath: /var/camrecommend/output
              subPath: camrecommend/output
            - name: cam-data
              mountPath: /var/camrecommend/aws-extract/output
              subPath: camrecommend/aws-extract/output
            - name: cam-data
              mountPath: /var/camrecommend/aws-analyze/output
              subPath: camrecommend/aws-analyze/output
            - name: cam-data
              mountPath: /var/camrecommend/aws-ingest/output
              subPath: camrecommend/aws-ingest/output
      containers:
      {{- template "isIcp" . -}}
      {{- if not (.Values.isIcp) }}
      - image: {{ template "cam.readConfig" (list . "cam_orchestrator_v2") }}
      {{ else }}
      - image: {{ template "camicp.readConfig" (list . "cam_orchestrator_v2" .Values.imageCredentials.registry) }}
      {{ end }}
{{ include "cam.container.securityContext.NonRoot" .  | indent 8 }}
        name: cam-orch-v2
        resources:
{{ include "deployClassConfig" (list . "cam_orchestrator_v2") | indent 10 }}
        readinessProbe:
            tcpSocket:
              port: cam-orch-v2
            initialDelaySeconds: 5
            periodSeconds: 10
        livenessProbe:
            httpGet:
              path: /api/health_check/
              port: cam-orch-v2
            initialDelaySeconds: 120
            periodSeconds: 120
            failureThreshold: 4
            timeoutSeconds: 20
        env:
          - name: MARIADB_SERVICE_USERID
            valueFrom:
              secretKeyRef:
                 name: mysql-username
                 key: mysql.username
          - name: MARIADB_SERVICE_PASSWORD
            valueFrom:
              secretKeyRef:
                 name: mysql-password
                 key: mysql.key
          - name: MARIADB_SERVICE_CERT
            value: /certs/maria_dev.crt
          - name: MARIADB_SERVICE_KEY
            value: /certs/maria_dev.key
          # DO NOT modify this conditional check
          {{ if not (eq (.Values.enableDevSettings|quote|lower) "\"true\"") }}
          # CAM_URL used for slack integration to identify server
          - name: CAM_URL
            value: {{ .Values.apiGatewayUrl }}
          # CAM_SLACK_WEBHOOK_URL for slack integration
          - name: CAM_SLACK_WEBHOOK_URL
            valueFrom:
              secretKeyRef:
                name: slack-hooks
                key: slackURL
          {{ end }}
          - name: DATALAKEPATH
            value: /zip
          - name: LOGGER_LEVEL
            value: debug
            # This needs to be changed according to the time zone of customer
          - name: BROKER_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-creds
                key: rabbitmq.password
          - name: BROKER_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-creds
                key: rabbitmq.username
          - name: GPD_DATALAKEPATH
            value: /var/gpd/zip
          - name: EXTRACTDIR
            value: /var/gpd/extracts
          - name: ANALYZE_TEMP
            value: /var/gpd/analyze_temp
          - name: UPLOADS_TEMP
            value: /var/gpd/temp_uploads
          - name: UPLOADS_STAGING
            value: /var/gpd/staged_uploads
          - name: CAM_RECOMMENDATION_OUTPUT
            value: /var/camrecommend/output
          - name: RECOMMENDATION_EXTRACT_OUTPUT_PATH
            value: /var/camrecommend/aws-extract/output/
          - name: RECOMMENDATION_ANALYZE_OUTPUT_PATH
            value: /var/camrecommend/aws-analyze/output/
          - name: RECOMMENDATION_INGEST_OUTPUT_PATH
            value: /var/camrecommend/aws-ingest/output/
          - name: CAMANALYTICS_ROUTING_KEY
            value: "cam-analytics"
          - name: SERVER_NAME
            value: "cam-orch-v2"
          - name: AUTH_SERVICE
            value: "http://cb-core-authorization-service.{{ .Values.coreNamespace }}:4004"
          - name: AUTH_INTERNAL_SERVICE
            value: "https://cb-core-auth-internal.{{ .Values.coreNamespace }}:4001"
          - name: CB_CRED_HOST
            value: "http://cb-cred-svc.{{ .Values.coreNamespace }}"
          - name: CB_CRED_PORT
            value: "8000"
          - name: ORCHESTRATOR_CRON_TIME
            value: "{{ .Values.orchestratorCronTime }}"
          - name: RECOMMENDATION_CRON_TIME
            value: "{{ .Values.recommendationCronTime }}"
          - name: LEGACY_TEMP_EXTRACT
            value: /zip/orchestrator/tmp/extract
          - name: PARALLELIZE_SUMMARIES
            value: "{{ .Values.parallelizeSummaries }}"
          # DO NOT modify this conditional check
          {{ if eq (.Values.externalDB.enableExternalDB|quote|lower) "\"true\"" }}
          - name: MARIADB_SERVICE_HOST
            value: {{ .Values.secrets.mariadbServiceHost }}
          - name: MARIADB_SERVICE_PORT
            value: "{{ .Values.secrets.mariadbServicePort}}"
          {{ end }}
        ports:
        - containerPort: 4081
          name: cam-orch-v2
        volumeMounts:
        - name: maria-cert-file
          mountPath: /certs/
        - name: cam-data
          mountPath: /var/gpd/analyze_temp
          subPath: gpd/analyze_temp
        - name: cam-data
          mountPath: /var/gpd/temp_uploads
          subPath: gpd/temp_uploads
        - name: cam-data
          mountPath: /var/gpd/staged_uploads
          subPath: gpd/staged_uploads
        - name: cam-data
          mountPath: /var/gpd/zip
          subPath: gpd/zip
        - name: cam-data
          mountPath: /var/gpd/extracts
          subPath: gpd/extracts
        - name: cam-data
          mountPath: /zip
        - name: cam-data
          mountPath: /var/camrecommend/output
          subPath: camrecommend/output
        - name: cam-data
          mountPath: /var/camrecommend/aws-extract/output
          subPath: camrecommend/aws-extract/output
        - name: cam-data
          mountPath: /var/camrecommend/aws-analyze/output
          subPath: camrecommend/aws-analyze/output
        - name: cam-data
          mountPath: /var/camrecommend/aws-ingest/output
          subPath: camrecommend/aws-ingest/output

      volumes:
      - name: maria-cert-file
        secret:
          secretName: grav-certificates
          items:
          - key: maria_dev.crt
            path: maria_dev.crt
          - key: maria_dev.key
            path: maria_dev.key
          - key: rootca.pem
            path: rootCA.pem
      - name: cam-data
        persistentVolumeClaim:
          claimName: cam-data-claim
      restartPolicy: Always
      # DO NOT modify this conditional check
      {{ if eq (.Values.externalDB.enableExternalDB|quote|lower) "\"true\"" }}
      nodeSelector:
        role: {{ .Values.nodeRole }}
        datacenter: {{ .Values.externalDB.dataCenter }}
      {{ end }}
