apiVersion: batch/v1
kind: Job
metadata:
  name: cam-migrator
  labels:
{{ include "cam.labels" .  | indent 4 }}
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: hook-failed,hook-succeeded
    helm.sh/hook-weight: "1"
spec:
  template:
    metadata:
      name: cam-migrator
      labels:
{{ include "cam.labels" .  | indent 8 }}
        task: db-schema-load
    spec:
{{ include "ibm-cloud-brokerage-cam.imagePullSecrets" .  | indent 6 }}
      affinity:
      {{- include "cam.nodeaffinity" . | indent 6 }}
{{ include "cam.securityContext" .  | indent 6 }}
      containers:
        - name: cam-migrator
        {{- template "isIcp" . -}}
        {{- if not (.Values.isIcp) }}
          image: {{ template "cam.readConfig" (list . "cam_migrator") }}
        {{ else }}
          image: {{ template "camicp.readConfig" (list . "cam_migrator" .Values.imageCredentials.registry) }}
        {{ end }}
{{ include "cam.container.securityContext" . | indent 10  }}
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-password
                  key: mysql.key
            - name: DB_HOST
              value: "mariadb"
            - name: DB_PORT
              # DO NOT modify this conditional check
              {{ if eq (.Values.externalDB.enableExternalDB|quote|lower) "\"true\"" }}
              value: {{ .Values.secrets.mariadbServicePort| quote }}
              {{ else }}
              value: {{ .Values.secrets.mariadbServicePort| quote }}
              {{ end }}
          command:
            - "bash"
            - "/entrypoint.sh"
      restartPolicy: Never
      # DO NOT modify this conditional check
      {{ if eq (.Values.externalDB.enableExternalDB|quote|lower) "\"true\"" }}
      nodeSelector:
        role: {{ .Values.nodeRole }}
        datacenter: {{ .Values.externalDB.dataCenter }}
      {{ end }}
