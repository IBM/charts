apiVersion: v1
kind: Pod
metadata:
  name: cam-rabbitmq-test
  labels:
    name: cam-rabbitmq-test
{{ include "cam.test-labels" .  | indent 4 }}
  annotations:
    "helm.sh/hook": test-success
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  affinity:
{{- include "cam.nodeaffinity" . | indent 4 }}
{{ include "cam.securityContext" .  | indent 2 }}
{{ include "ibm-cloud-brokerage-cam.imagePullSecrets" .  | indent 2 }}
  containers:
  - name: cam-rabbitmq-test
  {{- template "isIcp" . -}}
  {{- if not (.Values.isIcp) }}
    image: {{ template "cam.readConfig" (list . "k8_jumpbox") }}
  {{ else }}
    image: {{ template "camicp.readConfig" (list . "k8_jumpbox" .Values.imageCredentials.registry) }}
  {{ end }}
{{ include "cam.container.securityContext.NonRoot" . | indent 4  }}
    command: ["sh", "-c", "if (echo $(wget  http://rabbitmq:15672 -T 5 2>&1 >/dev/null) | grep -i 'connected') then exit 0; else exit 1; fi"]
  restartPolicy: Never
