###############################################################################
#  Licensed Materials - Property of IBM
#
# 5737-I89
# Â© Copyright IBM Corp. 2018 All Rights Reserved
# US Government Users Restricted Rights - Use, duplication or
# disclosure restricted by GSA ADP Schedule Contract with IBM Corp.
###############################################################################

apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: {{ template "icip-navigator.fullname" . }}
  labels:
    app: {{ template "icip-navigator.name" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
  annotations:
    ingress.kubernetes.io/rewrite-target: "/$2"
    ingress.kubernetes.io/secure-backends: "true"
    ingress.kubernetes.io/force-ssl-redirect: "true"
    ingress.kubernetes.io/backend-protocol: "HTTPS"
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: "/$2"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/secure-backends: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
spec:
{{- if .Values.tls.hostname }}
  tls:
    - hosts:
      - {{ .Values.tls.hostname }}
      secretName: {{ .Values.tls.secret }}
{{- end }}
  rules:
{{- if .Values.tls.hostname }}
    - host: {{ .Values.tls.hostname }}
      http:
        paths:
          - path: "/{{ .Values.tls.ingresspath }}(/|$)(.*)"
            backend:
              serviceName: {{ template "icip-navigator.fullname" . }}
              servicePort: 5055
{{- end }}
    - http:
        paths:
          - path: "/{{ .Values.tls.ingresspath }}(/|$)(.*)"
            backend:
              serviceName: {{ template "icip-navigator.fullname" . }}
              servicePort: 5055
