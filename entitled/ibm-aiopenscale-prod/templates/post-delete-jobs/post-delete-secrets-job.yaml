{{ $namePrefix := "post-delete-secrets-job" -}}
{{- include "sch.config.init" (list . "sch.chart.config.values" ) -}}
{{ $name := include "sch.names.fullCompName" (list . $namePrefix ) -}}
{{ $compName := "post-delete-job" -}}
{{ $labels := include "sch.metadata.labels.standard" (list . $compName) -}}
{{ $serviceAccount := "post-delete-aios" -}}
{{ $serviceAccountName := include "aios.serviceAccountNameEditor" (list . $serviceAccount) -}}
{{ $nonRootUser := include "aios.nonroot.uid" (list .) -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $name | quote }}
  labels:
{{ $labels | indent 4 }}
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-delete-policy": hook-succeeded, before-hook-creation
    "helm.sh/hook-weight": "3"
spec:
  activeDeadlineSeconds: 100
  template:
    metadata:
      name: {{ $name | quote }}
      labels:
{{ $labels | indent 8 }}
    spec:
      serviceAccountName: {{ $serviceAccountName | quote }}
      {{- if .Values.imagePullSecrets }}
      {{- if ne .Values.imagePullSecrets "default" }}
      imagePullSecrets:
        - name: {{ .Values.imagePullSecrets }}
      {{- end }}
      {{- end }}
      hostNetwork: false
      hostPID: false
      hostIPC: false
      securityContext:
        runAsNonRoot: true
        runAsUser: {{ $nonRootUser }}
      affinity:
      {{- include "aios.nodeAffinity" . | indent 8 }}
      restartPolicy: Never
      containers:
        - name: "delete-secrets"
          image: {{ include "aios.image" (list . .Values.kubectl.image.name .Values.kubectl.image.tag) | quote }}
          resources:
{{ toYaml .Values.ephemeralPod.resources | indent 12 }}
          imagePullPolicy: {{ default "IfNotPresent" .Values.imagePullPolicy | quote }}
          securityContext:
            privileged: false
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: {{ $nonRootUser }}
            capabilities:
              drop:
              - ALL
          command: 
            - "/bin/sh"
            - "-ec"
            - |
              set +e
              # Delete all secrets installed by the release
              kubectl -n {{ .Release.Namespace }} get secrets  -l release={{ .Release.Name }} | awk '{if(NR>1) print $1 }' | xargs kubectl -n {{ .Release.Namespace }} delete secrets
              # remove job created by private deployment cleanup cronjob
              kubectl -n {{ .Release.Namespace }} get job -l release={{ .Release.Name }} | awk '{if(NR>1) print $1 }' | xargs kubectl -n {{ .Release.Namespace }} delete job
              # remove all pvc
              kubectl -n {{ .Release.Namespace }} get pvc -l release=aiopenscale | awk '{if(NR>1) print $1 }' | xargs kubectl -n {{ .Release.Namespace }} delete pvc
              exit 0