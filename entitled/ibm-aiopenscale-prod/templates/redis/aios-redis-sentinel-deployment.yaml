{{- include "sch.config.init" (list . "sch.chart.config.values" ) -}}
{{ $nonRootUser := include "aios.nonroot.uid" (list .) -}}
{{ $serviceAccount := include "aios.serviceAccountNameEditor" (list . "redis-serviceaccount" ) }}
{{ $namePrefix := "redis-sentinel" -}}
{{ $compName := "aios-redis" -}}
{{ $name := include "sch.names.fullCompName" (list . $namePrefix ) -}}
{{ $labels := include "sch.metadata.labels.standard" (list . $compName) -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $name }}
  labels:
{{ $labels | indent 4}}

spec:
  strategy:
    rollingUpdate:
      maxUnavailable: 1
    type: RollingUpdate
  replicas: {{ .Values.redis.replicas.sentinels }}
  selector:
    matchLabels:
      release: {{ .Release.Name | quote }}
      name: {{ template "fullname" . }}-redis-sentinel
  template:
    metadata:
      labels:
{{ $labels | indent 8 }}
        component: sentinel
        name: {{ $name }}
      annotations:
      {{- include "aios.metering" . | indent 8 }}
    spec:
      hostNetwork: false
      hostPID: false
      hostIPC: false
      securityContext:
        runAsNonRoot: true
        runAsUser: {{ $nonRootUser }}
      {{ include "aios.fsGroupGid" (list . ) | indent 8 }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                  - amd64
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: {{ template "fullname" . }}
                  release: "{{ .Release.Name }}"
                  component: sentinel
              topologyKey: kubernetes.io/hostname
            weight: 1

      serviceAccountName: {{ $serviceAccount }}
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets:
        - name: {{ .Values.imagePullSecrets }}
      {{- end }}
      containers:
      - name: sentinel
        image: {{ include "aios.image" (list . .Values.redis.image.name .Values.redis.image.tag) | quote }}
        imagePullPolicy: {{ default "IfNotPresent" .Values.imagePullPolicy | quote }}
        command: ["/bin/sh", "-c", "echo \"requirepass ${REDIS_PASSWORD}\" >> /etc/redis/master.conf; echo \"requirepass ${REDIS_PASSWORD}\" >> /etc/redis/slave.conf; echo \"masterauth ${REDIS_PASSWORD}\" >> /etc/redis/slave.conf; /usr/local/bin/redis-launcher.sh"]
        securityContext:
            privileged: false
            readOnlyRootFilesystem: false
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: {{ $nonRootUser }}
            capabilities:
              drop:
              - ALL
        resources:
          requests:
{{ toYaml .Values.redis.resources.sentinel | indent 10 }}
        {{- if .Values.redis.sentinel.livenessProbe.enabled}}
        livenessProbe:
          initialDelaySeconds: {{ .Values.redis.sentinel.livenessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.redis.sentinel.livenessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.redis.sentinel.livenessProbe.timeoutSeconds }}
          successThreshold: {{ .Values.redis.sentinel.livenessProbe.successThreshold }}
          failureThreshold: {{ .Values.redis.sentinel.livenessProbe.failureThreshold }}
          exec:
            command:
            - redis-cli
            - "-p"
            - "26379"
            - SENTINEL
            - masters
        {{- end }}
        {{- if .Values.redis.sentinel.readinessProbe.enabled}}
        readinessProbe:
          initialDelaySeconds: {{ .Values.redis.sentinel.readinessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.redis.sentinel.readinessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.redis.sentinel.readinessProbe.timeoutSeconds }}
          successThreshold: {{ .Values.redis.sentinel.readinessProbe.successThreshold }}
          failureThreshold: {{ .Values.redis.sentinel.readinessProbe.failureThreshold }}
          exec:
            command:
            - redis-cli
            - "-p"
            - "26379"
            - SENTINEL
            - masters
        {{- end }}
        env:
          - name: SENTINEL
            value: "true"
          - name: REDIS_CHART_PREFIX
            value: {{ template "fullname" . }}-redis-
          - name: REDIS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ template "fullname" . }}-redis-secrets
                key: auth
        ports:
          - containerPort: 26379
