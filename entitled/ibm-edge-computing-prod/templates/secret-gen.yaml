apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-secret-gen
  labels:
    app: {{ .Release.Name }}-secret-gen
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/name: {{ .Release.Name }}-secret-gen
    helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
  annotations:
    "helm.sh/hook": pre-upgrade,pre-install
    "helm.sh/hook-delete-policy": "hook-succeeded,before-hook-creation"
spec:
  backoffLimit: 5
  activeDeadlineSeconds: 600
  template:
    metadata:
      name: {{ .Release.Name }}-secret-gen
      labels:
        app: {{ .Release.Name }}-secret-gen
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/managed-by: {{ .Release.Service }}
        app.kubernetes.io/name: {{ .Release.Name }}-secret-gen
        helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    spec:
      hostNetwork: false
      hostPID: false
      hostIPC: false
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
      {{- if .Values.global.image.pullSecret }}
      imagePullSecrets:
        - name: {{ .Values.global.image.pullSecret }}
      {{- end }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: "beta.kubernetes.io/arch"
                operator: In
                values:
                - {{ .Values.arch }}
      containers:
      - name: secret-gen
        image: {{ if .Values.global.image.repository }}{{ trimSuffix "/" .Values.global.image.repository }}{{ end }}/{{ .Values.kubectl.image }}:{{ .Values.kubectl.tag }}
        imagePullPolicy: {{ .Values.global.image.pullPolicy }}
        securityContext:
          privileged: false
          readOnlyRootFilesystem: false
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 65534
          capabilities:
            drop:
              - ALL
        command:
        - "/bin/bash"
        - -c
        - |
          CLUSTER_NAME=$(kubectl get configmap --namespace kube-public ibmcloud-cluster-info -o jsonpath="{.data.cluster_name}")
          GET_SECRET="kubectl --namespace kube-system get secret"
          GET_DB_SECRET="$GET_SECRET edge-computing-remote-dbs"
          {{- if .Values.localDBs.enabled }}
          export EDGE_AGBOT_DB_HOST={{ .Release.Name }}-agbotdb-proxy-svc \
          EDGE_AGBOT_DB_PORT=5432 \
          EDGE_AGBOT_DB_USER={{ .Values.agbotdb.auth.pgSuperuserName }} \
          EDGE_AGBOT_DB_NAME=postgres \
          EDGE_AGBOT_DB_PASS=$(openssl rand -hex 64 | tr -d '\n' | base64 | tr -d '\n') \
          EDGE_AGBOT_DB_REPL_PASS=$(openssl rand -hex 64 | tr -d '\n' | base64 | tr -d '\n') \
          EDGE_AGBOT_DB_SSL=disable \
          EDGE_CSS_DB_HOST={{ .Release.Name }}-cssdb-headless-svc.kube-system:27017 \
          EDGE_CSS_DB_AUTH=$(echo -n "admin" | base64 | tr -d '\n') \
          EDGE_CSS_DB_USER=$(echo -n "admin" | base64 | tr -d '\n') \
          EDGE_CSS_DB_PASS=$(openssl rand -hex 64 | tr -d '\n' | base64 | tr -d '\n') \
          EDGE_CSS_DB_SSL=false \
          EDGE_EXCHANGE_DB_HOST={{ .Release.Name }}-exchangedb-proxy-svc \
          EDGE_EXCHANGE_DB_PORT=5432 \
          EDGE_EXCHANGE_DB_USER={{ .Values.agbotdb.auth.pgSuperuserName }} \
          EDGE_EXCHANGE_DB_NAME=postgres \
          EDGE_EXCHANGE_DB_PASS=$(openssl rand -hex 64 | tr -d '\n' | base64 | tr -d '\n') \
          EDGE_EXCHANGE_DB_REPL_PASS=$(openssl rand -hex 64 | tr -d '\n' | base64 | tr -d '\n') \
          EDGE_EXCHANGE_DB_SSL=disable
          {{ else }}
          if $GET_SECRET edge-computing-remote-dbs > /dev/null 2>&1; then
            # Setting all the connection parameters for each DB, pulling from edge-computing-remote-dbs
            for CONNECTION_PARAM in HOST USER NAME SSL; do
              export EDGE_AGBOT_DB_${CONNECTION_PARAM}=$($GET_DB_SECRET -o jsonpath="{.data.agbot-db-$(echo $CONNECTION_PARAM | tr '[:upper:]' '[:lower:]')}" | base64 --decode | tr -d '\n') \
              EDGE_CSS_DB_${CONNECTION_PARAM}=$($GET_DB_SECRET -o jsonpath="{.data.css-db-$(echo $CONNECTION_PARAM | tr '[:upper:]' '[:lower:]')}" | base64 --decode | tr -d '\n') \
              EDGE_EXCHANGE_DB_${CONNECTION_PARAM}=$($GET_DB_SECRET -o jsonpath="{.data.exchange-db-$(echo $CONNECTION_PARAM | tr '[:upper:]' '[:lower:]')}" | base64 --decode | tr -d '\n')
            done
            # We export the password separately from the above because we want to keep the password base64 encoded for accuracy reasons
            export EDGE_AGBOT_DB_PASS=$($GET_DB_SECRET -o jsonpath="{.data.agbot-db-pass}") \
            EDGE_CSS_DB_PASS=$($GET_DB_SECRET -o jsonpath="{.data.css-db-pass}") \
            EDGE_EXCHANGE_DB_PASS=$($GET_DB_SECRET -o jsonpath="{.data.exchange-db-pass}")
            # We separate out the port for postgresql
            export EDGE_AGBOT_DB_PORT=$($GET_DB_SECRET -o jsonpath="{.data.agbot-db-port}" | base64 --decode | tr -d '\n') \
            EDGE_EXCHANGE_DB_PORT=$($GET_DB_SECRET -o jsonpath="{.data.exchange-db-port}" | base64 --decode | tr -d '\n')
            # Mongodb also has an auth DB
            export EDGE_CSS_DB_AUTH=$($GET_DB_SECRET -o jsonpath="{.data.css-db-auth}")
            # We also export the MongoDB users to stay base64 encoded for accuracy reasons
            export EDGE_CSS_DB_USER=$($GET_DB_SECRET -o jsonpath="{.data.css-db-user}")
          else
            echo "Value 'localDBs.enabled' is false, but secret edge-computing-remote-dbs is not defined, exiting"
            exit 1
          fi
          {{ end }}
          kubectl get secret {{ .Release.Name }} -o yaml | sed "s/name: {{ .Release.Name }}/name: {{ .Release.Name }}-backup/" | sed '/creationTimestamp:/d' | sed '/uid/d' | sed '/resourceVersion:/d' | kubectl apply -n kube-system -f-
          kubectl annotate secret {{ .Release.Name }}-backup kubectl.kubernetes.io/last-applied-configuration-
          AGBOT_MSG_KEY=$(openssl genrsa 2048 2>/dev/null) 
          export EDGE_AGBOT_MSG_KEY=$(echo "$AGBOT_MSG_KEY" | base64 -w 0 | tr -d '\n') \
          EDGE_AGBOT_MSG_PUB=$(echo "$AGBOT_MSG_KEY" | openssl rsa -pubout | base64 -w 0 | tr -d '\n') \
          EDGE_AGBOT_TOKEN=$(openssl rand -base64 40 | tr -d "=+/" | cut -c1-30 | tr -d '\n') \
          EDGE_EXCHANGE_ROOT_PASS=$(openssl rand -base64 40 | tr -d "=+/" | cut -c1-30 | tr -d '\n') \ 
          if $GET_SECRET {{ .Release.Name }} > /dev/null 2>&1; then
            export EDGE_CSS_DB_PASS=$($GET_SECRET {{ .Release.Name }} -o jsonpath="{.data.css-db-pass}") \
            EDGE_AGBOT_DB_PASS=$($GET_SECRET {{ .Release.Name }} -o jsonpath="{.data.agbot-db-pass}") \
            EDGE_AGBOT_TOKEN=$($GET_SECRET {{ .Release.Name }} -o jsonpath="{.data.agbot-token}" | base64 --decode | tr -d '\n') \
            EDGE_EXCHANGE_DB_PASS=$($GET_SECRET {{ .Release.Name }} -o jsonpath="{.data.exchange-db-pass}") \
            EDGE_EXCHANGE_ROOT_PASS=$($GET_SECRET {{ .Release.Name }} -o jsonpath="{.data.exchange-root-pass}" | base64 --decode | tr -d '\n') \
            EDGE_AGBOT_MSG_KEY=$($GET_SECRET {{ .Release.Name }} -o jsonpath="{.data.agbot-messagekey-private}") \
            EDGE_AGBOT_MSG_PUB=$($GET_SECRET {{ .Release.Name }} -o jsonpath="{.data.agbot-messagekey-public}")
          fi
          cat <<EOF | kubectl apply -n {{ .Release.Namespace }} -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: {{ .Release.Name }}
            labels:
              release: {{ .Release.Name }}
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/managed-by: {{ .Release.Service }}
              app.kubernetes.io/name: {{ .Release.Name }}
              helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
          type: Opaque
          data:
            agbot-messagekey-private: $EDGE_AGBOT_MSG_KEY
            agbot-messagekey-public: $EDGE_AGBOT_MSG_PUB
          stringData:
            agbot-db-pass: $(echo $EDGE_AGBOT_DB_PASS | base64 --decode | tr -d '\n')
            agbot-token: $EDGE_AGBOT_TOKEN
            agbot-config: |-
              {
                "Edge":{
                },
                "AgreementBot": {
                    "DBPath": "",
                    "Postgresql": {
                        "Host": "$EDGE_AGBOT_DB_HOST",
                        "Port": "$EDGE_AGBOT_DB_PORT",
                        "User": "$EDGE_AGBOT_DB_USER",
                        "Password": "$(echo $EDGE_AGBOT_DB_PASS | base64 --decode)",
                        "DBName": "$EDGE_AGBOT_DB_NAME",
                        "SSLMode": "$EDGE_AGBOT_DB_SSL"
                    },
                    "Partitions": "part0",
                    "TxLostDelayTolerationSeconds": 120,
                    "AgreementWorkers": 15,
                    "ProtocolTimeoutS": 120,
                    "AgreementTimeoutS": 600,
                    "NoDataIntervalS": 300,
                    "ActiveAgreementsURL": "",
                    "ActiveAgreementsUser": "",
                    "ActiveAgreementsPW": "",
                    "PolicyPath": "/home/agbotuser/policy.d",
                    "NewContractIntervalS": 10,
                    "ProcessGovernanceIntervalS": 10,
                    "IgnoreContractWithAttribs": "ethereum_account",
                    "ExchangeURL": "http://{{ .Release.Name }}-exchange/v1/",
                    "ExchangeId": "IBM/${CLUSTER_NAME}-agbot",
                    "ExchangeToken": "$EDGE_AGBOT_TOKEN",
                    "ExchangeVersionCheckIntervalM": 1,
                    "ExchangeHeartbeat": 60,
                    "ExchangeMessageTTL": 1800,
                    "ActiveDeviceTimeoutS": 180,
                    "DefaultWorkloadPW": "",
                    "MessageKeyPath": "msgKey",
                    "APIListen": "127.0.0.1:8080",
                    "PurgeArchivedAgreementHours": 1,
                    "CheckUpdatedPolicyS": 15,
                    "CSSURL": "http://{{ .Release.Name }}-css"
                }
              }
            css-db-pass: $(echo $EDGE_CSS_DB_PASS | base64 --decode | tr -d '\n')
            css-config: |-
              NodeType CSS
              ListeningType unsecure
              UnsecureListeningPort 8080
              CommunicationProtocol http
              LogLevel INFO
              LogTraceDestination stdout
              TraceLevel INFO
              MongoAddressCsv $EDGE_CSS_DB_HOST
              MongoAuthDbName $(echo $EDGE_CSS_DB_AUTH | base64 --decode | tr -d '\n')
              MongoUsername $(echo $EDGE_CSS_DB_USER | base64 --decode | tr -d '\n')
              MongoPassword $(echo $EDGE_CSS_DB_PASS | base64 --decode | tr -d '\n')
              MongoUseSSL $EDGE_CSS_DB_SSL
            exchange-db-pass: $(echo $EDGE_EXCHANGE_DB_PASS | base64 --decode | tr -d '\n')
            exchange-root-pass: $EDGE_EXCHANGE_ROOT_PASS
            exchange-config: |-
              {
                "api": {
                  "db": { "jdbcUrl": "jdbc:postgresql://$EDGE_EXCHANGE_DB_HOST:$EDGE_EXCHANGE_DB_PORT/$EDGE_EXCHANGE_DB_NAME",
                    "user": "$EDGE_EXCHANGE_DB_USER",
                    "password": "$(echo $EDGE_EXCHANGE_DB_PASS | base64 --decode)",
                    "maxPoolSize": "{{.Values.exchange.dbPool}}"
                  },
                  "logging": {
                    "level": "{{ .Values.exchange.loglevel }}"
                  },
                  "cache": {
                    "idsMaxSize": {{ .Values.exchange.cache.idsMaxSize }},
                    "resourcesMaxSize": {{ .Values.exchange.cache.resourcesMaxSize }}
                  },
                  "root": { 
                    "password": "$EDGE_EXCHANGE_ROOT_PASS"
                  }
                }
              }
          EOF
          {{- if .Values.localDBs.enabled }}
          cat <<EOF | kubectl apply -n {{ .Release.Namespace }} -f -
          apiVersion: v1
          kind: Secret
          metadata:
            labels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/managed-by: {{ .Release.Service }}
              app.kubernetes.io/name: {{ .Release.Name }}-agbot-db
              helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
              release: agbot-db
            name: edge-computing-agbotdb-postgresql-auth-secret
          data:
            pg_repl_password: $EDGE_AGBOT_DB_REPL_PASS
            pg_su_password: $EDGE_AGBOT_DB_PASS
          EOF
          cat <<EOF | kubectl apply -n {{ .Release.Namespace }} -f -
          apiVersion: v1
          kind: Secret
          metadata:
            labels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/managed-by: {{ .Release.Service }}
              app.kubernetes.io/name: {{ .Release.Name }}-exchange-db
              helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
              release: exchange-db
            name: edge-computing-exchangedb-postgresql-auth-secret
          data:
            pg_repl_password: $EDGE_EXCHANGE_DB_REPL_PASS
            pg_su_password: $EDGE_EXCHANGE_DB_PASS
          EOF
          cat <<EOF | kubectl apply -n kube-system -f -
          apiVersion: v1
          kind: Secret
          metadata:
            labels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/managed-by: {{ .Release.Service }}
              app.kubernetes.io/name: {{ .Release.Name }}-css-db
              helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
              release: css-db
            name: edge-computing-css-db-ibm-mongodb-auth-secret
          data:
            password: $EDGE_CSS_DB_PASS
            user: $EDGE_CSS_DB_AUTH
          EOF
          {{ end }}
          kubectl annotate secret {{ .Release.Name }} kubectl.kubernetes.io/last-applied-configuration-
        resources:
          requests:
            memory: 100Mi
            cpu: 100m
          limits:
            memory: 200Mi
            cpu: 200m
      restartPolicy: Never
