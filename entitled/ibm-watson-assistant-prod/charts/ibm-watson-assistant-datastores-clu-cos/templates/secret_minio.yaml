{{- include "sch.config.init" (list . .Values.global.schConfigTemplate) -}}

{{- if (not .Values.global.cos.sse.secretName) -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ .Release.Name }}-gen-secret-cos"
{{ include "clu.labels" . | indent 2 }}
    lifecycle: "install"
spec:
  backoffLimit: 5
  activeDeadlineSeconds: 300
  template:
    metadata:
      name: sse-gen
{{ include "clu.labels" . | indent 6 }}
        lifecycle: "install"
    spec:
      affinity:
{{- include "sch.affinity.nodeAffinity" (list . .sch.chart.nodeAffinity) | indent 8 }}
      hostIPC: false
      hostNetwork: false
      hostPID: false

      serviceAccountName: {{ (printf "%s-credentials" .Release.Name) | quote }}
      containers:
      - name: sse-gen
        image: "{{ if tpl ( .Values.creds.image.repository | toString ) . }}{{ trimSuffix "/" (tpl (.Values.creds.image.repository | toString ) . ) }}{{ end }}/{{ .Values.creds.image.name }}:{{ .Values.creds.image.tag }}"
        imagePullPolicy: {{ .Values.creds.image.pullPolicy | quote }}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          privileged: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 2000

        command:
        - "/bin/sh"
        - -c
        - |
          
          cat <<EOF | kubectl apply -n {{ .Release.Namespace }} -f -
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ .Release.Name }}-clu-minio-sse"
          {{ include "clu.labels" . | indent 12 }}
          type: Opaque
          data:
            {{ .Values.minio.sse.masterKeyName }}: $(echo 'KEY_ID:'$(openssl rand -hex 32 | tr -d '\n') | tr -d '\n' | base64 | tr -d '\n')
      restartPolicy: Never
{{- end }}
