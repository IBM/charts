###############################################################################
# Licensed Materials - Property of IBM.
# Copyright IBM Corporation 2018. All Rights Reserved.
# U.S. Government Users Restricted Rights - Use, duplication or disclosure 
# restricted by GSA ADP Schedule Contract with IBM Corp.
#
# Contributors:
#  IBM Corporation - initial API and implementation
###############################################################################
{{- include "sch.config.init" (list . .Values.global.schConfigTemplate) }}
{{- define "assistant.redis.authsecret" -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ tpl .Values.config.auth.authSecretName . | quote }}
  labels:
{{ include "sch.metadata.labels.standard" (list . "") | indent 4 }}
    component: "helm-redis-generate-password-secret"
data:
  {{- if .Values.global.redis.auth.authSecretName }}
  password: $(echo "${REDIS_PASSWORD}" | tr -d '\n' | base64 | tr -d '\n')
  {{- else }}
  password: $(openssl rand -base64 16  | tr -d '\n' | base64 | tr -d '\n')
  {{- end }}
{{- end }}

apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ .Release.Name }}-gen-secret-redis"
  labels:  &labels
{{ include "sch.metadata.labels.standard" (list . "") | indent 4 }}
    component: "helm-redis-generate-password-secret"
spec:
  backoffLimit: 10
  template:
    metadata:
      name: cred-gen
      labels: 
        <<: *labels
    spec:
      serviceAccountName: {{ (printf "%s-credentials" .Release.Name) | quote }}
      #imagePullSecrets:
      affinity:
{{- include "sch.affinity.nodeAffinity" (list .) | indent 8 }}
      hostIPC: false
      hostNetwork: false
      hostPID: false

      containers:
      - name: cred-gen
        image: "{{ if tpl ( .Values.creds.image.repository | toString ) . }}{{ trimSuffix "/" (tpl (.Values.creds.image.repository | toString ) . ) }}{{ end }}/{{ .Values.creds.image.name }}:{{ .Values.creds.image.tag }}"
        imagePullPolicy: {{ .Values.creds.image.pullPolicy | quote }}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          privileged: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 2000

{{- if .Values.global.redis.auth.authSecretName }}
        env:
          - name: "REDIS_PASSWORD"
            valueFrom:
              secretKeyRef:
                name: {{ .Values.global.redis.auth.authSecretName | quote }}
                key: password
{{- end }}
        command:
        - "/bin/sh"
        - -c
        - |
          set -e
          cat <<EOF | kubectl apply -n {{ .Release.Namespace }} -f -
          ---
{{ include "assistant.redis.authsecret" . | indent 10 }}
      restartPolicy: Never
