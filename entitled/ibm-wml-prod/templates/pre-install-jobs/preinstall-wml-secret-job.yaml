apiVersion: batch/v1
kind: Job
metadata:
  name: preinstall-wml-secret
  labels:
    app: preinstall-wml-secret
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-delete-policy": hook-succeeded, before-hook-creation
    "helm.sh/hook-weight": "3"
spec:
  activeDeadlineSeconds: 300
  template:
    metadata:
      name: preinstall-wml-secret
      labels:
        app: preinstall-wml-secret
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                  - amd64
      serviceAccount: {{ .Values.global.editor.sa }}
      serviceAccountName: {{ .Values.global.editor.sa }}
      restartPolicy: Never
      containers:
        - name: "wml-kubectl"
          image: "{{ .Values.global.docker_registry_prefix }}/{{ .Values.wmlPreinstall.image.repository }}:{{ .Values.wmlPreinstall.image.tag }}"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsUser: {{ .Values.global.user.id }}
          resources:
            limits:
              cpu: "0.5"
              memory: "256Mi"
            requests:
              cpu: "0.5"
              memory: "256Mi"
          securityContext:
            privileged: false
            readOnlyRootFilesystem: false
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: {{ .Values.global.user.id }}
            capabilities:
              drop:
              - ALL
          command:
          - "/bin/bash"
          - -c
          - |
            cat <<EOF | kubectl apply -f -
            apiVersion: v1
            kind: Secret
            metadata:
              name: "etcd-secret"
              labels:
                app: wml-etcd
                chart: "{{ .Chart.Name }}"
                release: "{{ .Release.Name }}"
                heritage: "{{ .Release.Service }}"
            type: Opaque
            data:
              etcd_cluster: aHR0cDovL3dtbC1ldGNkOjIzNzk=
              etcd_password: `cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1 | tr -d '\n' | base64 | tr -d '\n'`
              etcd_username: cm9vdA==
            EOF
            cat <<EOF1 | kubectl apply -f -
            apiVersion: v1
            kind: Secret
            metadata:
              name: "wml-scoring-svc-secret"
              labels:
                app: wml-scoring-svc-secret
                chart: "{{ .Chart.Name }}"
                release: "{{ .Release.Name }}"
                heritage: "{{ .Release.Service }}"
            type: Opaque
            data:
              WML_SCORING_SVC_RM_ADMIN_SECRET: `cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1 | tr -d '\n' | base64 | tr -d '\n'`
            EOF1
            cat <<EOF2 | kubectl apply -f -
            apiVersion: v1
            data:
              keystore_password: d21sNGljcCE=
              server_key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRREZyWFhydTFqQVZMd0IKLzAxL01ZTmhkZFJDLzNqZTBTN0FYRHlEeWFvYzU3TTlZVzlQMFVVL0R2NjFUOHBDdWhKWlN3N0FpUFRqVkRRRQpZYzlGL3VKQ2ZhUkRDeFZjZzlFQ25SczdEWjkwZzh2TEdndW5mM0dJTnlHa2ltSHBoNjI4dHZ2TkNKcFNaWThSCkcyMWlRU0xLb0dtRnhQeEVKOVNGTGFGUm5paDJvRHZtcFlwUnVnTCtwZm9yL1RsWDFtUTdKbHZHdGt3dVJYaFQKK2gwN0tad1lWandFbDdQUUN3Yk54aGUzc0pXcEhiSDdjblRIb28xK2dQVWlFQXAxQjJXRC9CcHRKd0dDZ2dULwoveUJjY25lM0dFUlM0R3NGa053NXpFTTVOS1B5TngzTUFBaUZDYUVwKzVva0g2M1BNSFlQck1EYm4wakp6VGllCnRLaVFLakhMQWdNQkFBRUNnZ0VCQUlQUHFuWEpzdUJzb0FEazhCUUVQQXJjdXZFQjBPTWlzUDNyZ3g2TmRqVlgKK3BqUFE1NEJlUjhYTEpoUjRCaW1ZbDNRUXNIM2tQT1V6aXF0M2J4YXZSeUJFdXJ4bFFqZmpKc2xqMmJOS3FwUwp4NjFpYktyL3ZBQ01ZbzZKQjhqa2crRDJVdWpnOTZaQnVpZzZGYklTcE5SZ0tuemNZU3BCTk9DcEVJeVAzWU5iCklCNXFmZFNpdVdMbXF5ZWNYZkZOOU1wQS92RG1WUXVLNk9GY2tGQ3FaZTM1N0szTUtUNGNnVUhhZ0FuREJWQXMKa3hrL1JVVXF3bzZFZm10TlJ2VmkwTDJFamJLc1NMTG9EMThvSnNDMUhMQno5U3lqajRUTTVTUEhCK2VlUUdLVgplTUZsSVVjRzlhSkxDNVZ2RWM5TDlkMlNNQlQwZHNPd2RnK1JZNHR6bTJFQ2dZRUE4N1AyaUMzUWlmVDI0ZVRoCmNTTXV6dkl3Zmo3a1JYVEltOEd0UWxSM1laSm00bElaUXRkQlBqYzFuV0NOOWdzMW9wNnNxMldrTXRrY0NnMlIKZTl1SVYvT25GYVhzenNiS25aaU5hY2owOGFhdVRrMzRBay8wclJhSWtJSmVROWsrK05ONytyQlN2MGUyNXVQNAp5M3JRNDRybGkzYXpZMjhSeE9VNC9uNVRFNFVDZ1lFQXo2YjJ1OWtRdTl1WGlIdU5vYVpCaGJsL0NEeWtPay9hCnRNNFJhNkx2M1VKNVFpd3locEF5NGNtbURGTENSa1lBQ1NSaFVSbnFRQ2p0SmptUS9ET0IrRGIvOXBzcG9wVFEKWko3Rlp5S0w1eTdCVk16VVg1R1JpTTlhQi9nemtQOEt4dkZibmdpWHNKa1Zyd0dxVWthenFpMHY2ekJEOVBXbQpKRVBJN1N6bzZROENnWUVBc0JXekp2Zzdlc0xGODdoRjhGSmtpdURSaXhaMEozOVhSN3RzTGNZTU1ETHhKY3YrCk5wNkRwS21Oa3JYbVBRWWliZXJLaGxrOWlBUDVUNFk0UFU4Rk44OTBSWjhLK09rSUUxRGJ0TGlmeTA4TkdNVWIKVXNoazJQKzBFdjR2a0VTVFRJUzZTd3RGN3JHcGhURHBYbFRTUStiakxwN0l4U3JHb3dhZzVMbHYyMlVDZ1lBYgpSd0tJWUpaTEp5aDd2RWM1b2Q1Zms2TjFVSW4rUXZrbTRSNzJ0YnV1cEFuTHdJU09tcWlrY2xuR3FxUnNtTXR1CmFBSUVwbFBZUThnTFNtcWFScVhmRmxKL2NaaUJpK3pvR3RjeG1oOG9xa0twUWhMdnp1NkFPMFRIWVRwYzVMUGsKdUZYaHA1MU5qSDZGczhGTTk0Nm9YekU1UXVqYVo5NkFTd3M4NUxaZnp3S0JnSEkvbGI4bHBnbjlZU0Zkcit4eQpXN0kvRDVUdHhSbTdTZ1BMZUZ2bSthSE5acXh1ZGlaN1dRMTlQRnpIQ2l1NHh6ZjBMWGgydEcyMjBrNWp0TnlzCkNYelJEREVwUm9oakhCOE5DZGxpelNNbFU1SkxyZGZCTkQrY3JYNllrZGoxWm9XU1h2RVNPTnUxL0tuN0xxQ0cKM1hXS1V0aXdHZlVjRmplUDV1bGUwSkJWCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
              truststore_password: d21sNGljcCE=
            kind: Secret
            metadata:
              name: ssl-secret
              labels:
                app: ssl-secret
                chart: "{{ .Chart.Name }}"
                release: "{{ .Release.Name }}"
                heritage: "{{ .Release.Service }}"
            type: Opaque
            EOF2
            cat <<EOF4 | kubectl apply -f -
            apiVersion: v1
            data:
              glusterfs_path: L3dtbC1hc3NldHMv
              ssl_password_icp: d21sNGljcCE=
              ssl_path_icp: L29wdC9pYm0vcmVwb3NpdG9yeS9rZXlzL2ljcGtleXN0b3JlLmprcw==
              training_data_path: L3dtbC10cmFpbmluZy1kYXRh
              predefined_runtime: OHdaaWRnU0IxNA==
            kind: Secret
            metadata:
              name: repo-secrets
              labels:
                app: wmlrepository
                chart: "{{ .Chart.Name }}"
                release: "{{ .Release.Name }}"
                heritage: "{{ .Release.Service }}"
            type: Opaque
            EOF4
            cat <<EOF5 | kubectl apply -f -
            apiVersion: v1
            data:
              key_store_password : d21sNGljcCE=
            kind: Secret
            metadata:
              name: training-secrets
              labels:
                app: mltraining4icp
                chart: "{{ .Chart.Name }}"
                release: "{{ .Release.Name }}"
                heritage: "{{ .Release.Service }}"
            type: Opaque
            EOF5