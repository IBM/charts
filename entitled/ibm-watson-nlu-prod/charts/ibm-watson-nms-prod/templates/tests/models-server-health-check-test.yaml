{{- include "sch.config.init" (list . "nms.sch.chart.config.values") -}}
{{- $icpModelsServerCompName  :=  .sch.chart.components.nms.name -}}
{{- $icpModelsServerTestCompName := printf "%s-health-test" $icpModelsServerCompName -}}
{{- $icpPullSecrets := include "icp-pull-secrets" . -}}

apiVersion: v1
kind: Pod
metadata:
  name: {{ include "sch.names.fullCompName" (list . $icpModelsServerTestCompName) }}
  labels:
    heritage: {{ .Release.Service }}
    release: {{ .Release.Name }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    app: {{ include "sch.names.fullCompName" (list . $icpModelsServerTestCompName) }}
  annotations:
    "helm.sh/hook": test-success
spec:
{{- include "sch.security.securityContext" (list . .sch.chart.testSpecSecurityContext) | indent 2 }}
  containers:
    - name: {{ include "sch.names.fullCompName" (list . $icpModelsServerTestCompName) }}
      image: "{{ .Values.global.icpDockerRepo }}{{ .Values.global.tests.image.repository }}:{{ .Values.global.tests.image.tag }}"
      command: ['curl']
      args: ['-k', '-i', '-H Accept: application/json', 'https://{{ include "sch.names.fullCompName" (list . $icpModelsServerCompName) }}:8000/health']
{{- include "sch.security.securityContext" (list . .sch.chart.testContainerSecurityContext) | indent 6 }}
      resources:
        requests:
          memory: {{ .Values.global.tests.resources.requests.memory }}
          cpu: {{ .Values.global.tests.resources.requests.cpu }}
        limits:
          memory: {{ .Values.global.tests.resources.limits.memory }}
          cpu: {{ .Values.global.tests.resources.limits.cpu }}
  restartPolicy: Never
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: beta.kubernetes.io/arch
            operator: In
            values:
            - "amd64"
  imagePullSecrets:
  - name: {{ $icpPullSecrets | quote }}
