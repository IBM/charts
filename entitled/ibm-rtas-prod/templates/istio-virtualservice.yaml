{{- $ingress := .Values.ingress -}}
{{- if and $ingress.enabled (eq $ingress.type "istio") -}}
{{- $fullName := include "gateway.fullname" . -}}
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ $fullName }}
spec:
  gateways:
  - {{ default $fullName .Values.ingress.gatewayName }}
  hosts:
  - {{ .Values.global.ibmRtasIngressDomain }}
  http:
  - match:
    - uri:
        prefix: /auth
    route:
    - destination:
        host: {{ printf "%s-%s" .Release.Name "ssocloak" | trunc 20 | trimSuffix "-" }}-http
        port:
          number: 80
  - match:
    - uri:
        prefix: /api/
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /datasets/v2/api-docs
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /jobservice/v2/api-docs
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /management/
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /rest/
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /results/analytics/
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /results/ftwebreport/
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /results/rest/
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /results/static/
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /results/v2/api-docs
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /rm/
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /sse/
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /sso/
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /swagger-resources
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /testassets/v2/api-docs
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /v2/api-docs
    route:
    - destination:
        host: gateway
        port:
          number: 8080
  - match:
    - uri:
        prefix: /webhook/
    route:
    - destination:
        host: tam
        port:
          number: 8900
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: {{ printf "%s-%s" .Release.Name "frontend" | trunc 63 | trimSuffix "-" }}
        port:
          number: 80
{{- end }}
