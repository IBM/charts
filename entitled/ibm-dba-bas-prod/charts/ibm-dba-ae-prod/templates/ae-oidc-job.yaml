################################################################################
# Licensed Materials - Property of IBM
#
# (C) Copyright IBM Corp. 2019. All Rights Reserved.
#
# US Government Users Restricted Rights - Use, duplication or
# disclosure restricted by GSA ADP Schedule Contract with IBM Corp.
#
################################################################################
{{ include "sch.config.init" (list . "sch.appengine.config.values") }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "sch.names.fullCompName" (list . "oidc") }}-{{ randNumeric 3}}
  labels:
{{ include "sch.metadata.labels.standard" (list . "oidc") | indent 4 }}
spec:
  backoffLimit: 5
  template:
    metadata:
      name: solution-server-oidc-job
      labels:
{{ include "sch.metadata.labels.standard" (list . "oidc") | indent 8 }}
    spec:
{{ include "appengine.constants.pod.securityContext" . | indent 6 }}
      affinity:
{{- include "sch.affinity.nodeAffinity" (list . .sch.chart.nodeAffinity) | indent 8 }}
      restartPolicy: OnFailure
      serviceAccountName: {{ include "sch.names.fullCompName" (list . "deployment-access") }}
      securityContext:
        runAsNonRoot: true
{{- if not (.Capabilities.APIVersions.Has "security.openshift.io/v1") }}
        runAsUser: 50001
{{- end }}
{{- include "appengine.imagePullSecrets" . | indent 6 }}
      containers:
      - name: oidc-init
        image: {{ .Values.images.oidcJob | quote }}
        imagePullPolicy: {{ .Values.images.pullPolicy | quote }}
        securityContext:
{{ include "appengine.constants.container.securityContext" . | indent 10 }}
        env:
        - name: CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: {{ .Values.adminSecretName | quote }}
              key: OPENID_CLIENT_ID
        - name: CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: {{ .Values.adminSecretName | quote }}
              key: OPENID_CLIENT_SECRET
        - name: OIDC_HOST
          value: {{ .Values.global.ums.hostname | quote }}
        - name: OIDC_PORT
          value: {{ .Values.global.ums.port | quote }}
        - name: OIDC_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ .Values.global.ums.adminSecretName | quote }}
              key: adminUser
        - name: OIDC_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.global.ums.adminSecretName | quote }}
              key: adminPassword
        - name: REDIRECT_URIS
          valueFrom:
            configMapKeyRef:
              name: {{ include "sch.names.fullCompName" (list . "env") }}
              key: OPENID_CALLBACK_URL
        resources:
{{ .Values.resources.initContainer | toYaml | trim | indent 10 }}
